---
#
# Tasks install the backend application
#
- name: Define a name of EC2 group
  set_fact:
    ec2_groupname: "{{ ec2_frontend_inventory_group_name }}"


- name: Get a list of EC2 intances deployed within the infra
  ec2_instance_facts:
    region: "{{ aws_region }}"
    filters:
      "tag:appName": "{{ ec2_instance_tag_appname }}"
      "instance-state-name": "running"
  register: ec2_instances


- name: Make sure that we have found EC2 instances
  assert:
    that: ec2_instances.instances | length > 0
    fail_msg: "Not found EC2 instances. Cannot install frontend"
    success_msg: "Found {{ ec2_instances.instances | length }} EC2 instances"


- name:
  debug:
    var: ec2_instances


- name: Add found EC2 instances into inventory
  add_host:
    groups: "{{ ec2_groupname }}"
    name: "{{ item.public_dns_name }}"
    ansible_host: "{{ item.public_ip_address }}"
    ansible_ssh_user: "{{ ec2_user }}"
    ansible_ssh_private_key_file: "{{ ec2_ssh_privkey_file }}"
  loop: "{{ ec2_instances.instances }}"


- name: Hosts in the inventory
  debug:
    var: groups[ec2_groupname]


- name: Ping the EC2 hosts
  ping:
  when: inventory_hostname in groups[ec2_groupname]
  connection: ssh


- meta: end_play

